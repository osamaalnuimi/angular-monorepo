<div class="p-4 bg-white">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <p-card styleClass="shadow-md">
    <ng-template pTemplate="title">
      <div class="flex justify-between items-center">
        <h2 class="text-xl font-semibold text-gray-800">Role Management</h2>
        <p-button
          label="Create New Role"
          icon="pi pi-plus"
          (onClick)="openCreateDialog()"
          styleClass="p-button-success"
          *hasRole="'Super Admin'"
        ></p-button>
      </div>
    </ng-template>

    <ng-template pTemplate="content">
      <!-- Loading spinner -->
      @if (loading()) {
      <div class="flex justify-center my-8">
        <p-progressSpinner></p-progressSpinner>
      </div>
      }

      <!-- Error message -->
      @if (error()) {
      <div class="bg-red-100 text-red-700 p-3 rounded-md mb-4">
        {{ error() }}
      </div>
      }

      <!-- Roles table -->
      @if (hasRoles() && !loading()) {
      <div class="overflow-x-auto">
        <p-table
          [value]="roles()"
          [paginator]="true"
          [rows]="10"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Showing {first} to {last} of {totalRecords} roles"
          [rowsPerPageOptions]="[5, 10, 25, 50]"
          styleClass="border border-gray-200"
        >
          <ng-template pTemplate="header">
            <tr class="bg-gray-50">
              <th class="text-gray-700 border-b border-gray-200 p-3">ID</th>
              <th class="text-gray-700 border-b border-gray-200 p-3">Name</th>
              <th class="text-gray-700 border-b border-gray-200 p-3">
                Permissions
              </th>
              <th class="text-gray-700 border-b border-gray-200 p-3">
                Actions
              </th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-role>
            <tr class="border-b border-gray-200 hover:bg-gray-50">
              <td class="text-gray-800 p-3">
                {{ role.id }}
              </td>
              <td class="text-gray-800 p-3">
                {{ role.name }}
              </td>
              <td class="p-3">
                <div class="flex flex-wrap gap-2">
                  @for (permission of role.permissions; track permission) {
                  <span
                    class="px-3 py-1 text-sm rounded-full bg-blue-100 text-blue-800"
                  >
                    {{ permission }}
                  </span>
                  } @empty {
                  <span class="text-gray-500">No permissions</span>
                  }
                </div>
              </td>
              <td class="p-3">
                <div class="flex gap-2">
                  <p-button
                    icon="pi pi-pencil"
                    styleClass="p-button-rounded p-button-text p-button-warning"
                    pTooltip="Edit Role"
                    tooltipPosition="top"
                    (onClick)="openEditDialog(role)"
                    *hasRole="'Super Admin'"
                  ></p-button>
                  <p-button
                    icon="pi pi-trash"
                    styleClass="p-button-rounded p-button-text p-button-danger"
                    pTooltip="Delete Role"
                    tooltipPosition="top"
                    (onClick)="confirmDelete(role)"
                    *hasRole="'Super Admin'"
                  ></p-button>
                </div>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="4" class="text-center py-6 text-gray-500">
                No roles found. Create a new role to get started.
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
      }

      <!-- Empty state -->
      @if (!hasRoles() && !loading()) {
      <div
        class="flex flex-col items-center justify-center py-10 text-center bg-gray-50 rounded-lg"
      >
        <i class="pi pi-users text-5xl mb-4 text-gray-400"></i>
        <h3 class="text-xl font-semibold mb-2 text-gray-800">
          No Roles Available
        </h3>
        <p class="text-gray-600 mb-2">
          Create your first role to get started with user management.
        </p>
        <p-button
          label="Create New Role"
          icon="pi pi-plus"
          (onClick)="openCreateDialog()"
          styleClass="p-button-success mt-3"
          *hasRole="'Super Admin'"
        ></p-button>
      </div>
      }
    </ng-template>
  </p-card>

  <!-- Role Dialog (Create/Edit) -->
  <p-dialog
    [visible]="displayDialog()"
    (visibleChange)="displayDialog.set($event)"
    [style]="{ width: '500px' }"
    [header]="dialogMode() === 'create' ? 'Create New Role' : 'Edit Role'"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
  >
    <roles-ui-manage-form
      [mode]="dialogMode()"
      [role]="selectedRole()"
      [availablePermissions]="permissions()"
      (save)="saveRole($event)"
      (cancelSave)="closeDialog()"
    >
    </roles-ui-manage-form>
  </p-dialog>
</div>
